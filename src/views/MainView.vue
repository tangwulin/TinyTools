<template>
  <div class="flex items-center justify-center flex-col w-max h-auto m-auto">
    <div id="target-div" class="m-auto md:w-fit ">
      <div class="flex items-center justify-center mb-4">
        <n-button :size='"large"'>讲台</n-button>
      </div>
      <div>
        <SeatTable v-model:seats="allSeats" v-model:rendering-list="oldRenderingList" :key="stKey"
                   :coloring-edge="coloringEdgeSeats"/>
      </div>
      <div class="flex justify-center mt-4">
        <p>{{ currentDate }}--{{ currentTime }}</p>
      </div>
    </div>
    <div class="flex items-center justify-center mt-8 flex-col">
      <div class="flex items-center justify-center flex-col md:flex-row flex-wrap md:w-3/5"> <!-- 操作区域 -->
        <!--        <n-button @click="reloadSeatTable" :disabled="loading">重载座位表组件</n-button>-->
        <n-tooltip trigger="hover">
          <!--suppress VueUnrecognizedSlot -->
          <template #trigger>
            <n-button @click="replaceSeats" :loading="loading">
              <template #icon>
                <n-icon>
                  <RefreshDot/>
                </n-icon>
              </template>
              重新排列座位
            </n-button>
          </template>
          ”优化“后的排座位方式，不会连续两次抽到边缘位置
        </n-tooltip>
        <n-tooltip trigger="hover">
          <!--suppress VueUnrecognizedSlot -->
          <template #trigger>
            <n-button @click="rollSeats(5)" :loading="loading">
              <template #icon>
                <n-icon>
                  <RefreshDot/>
                </n-icon>
              </template>
              按规则Roll座位
            </n-button>
          </template>
          先随机5次并展示每次结果，再将原始位置按“重新排列座位”的做法排列（虚 晃 一 枪）
        </n-tooltip>
        <n-tooltip trigger="hover">
          <!--suppress VueUnrecognizedSlot -->
          <template #trigger>
            <n-popconfirm
                positive-text="确定"
                :negative-text="null"
                @positive-click="rollSeats(times)"
            >
              <!--suppress VueUnrecognizedSlot -->
              <template #trigger>
                <n-button @click="" :loading="loading">
                  <template #icon>
                    <n-icon>
                      <RefreshDot/>
                    </n-icon>
                  </template>
                  玩把大的！
                </n-button>
              </template>
              <div class="flex flex-row items-center">
                次数：
                <n-input-number clearable :precision="0" v-model:value="times"/>
              </div>
            </n-popconfirm>
          </template>
          与”按规则Roll座位“一样，只不过次数可以改
        </n-tooltip>
        <n-tooltip trigger="hover">
          <!--suppress VueUnrecognizedSlot -->
          <template #trigger>
            <n-button @click="gacha" :loading="loading">
              <template #icon>
                <n-icon>
                  <RefreshDot/>
                </n-icon>
              </template>
              抽卡！
            </n-button>
          </template>
          与”重新排列座位“一样，只不过会一个个的展示结果
        </n-tooltip>
        <n-tooltip trigger="hover">
          <!--suppress VueUnrecognizedSlot -->
          <template #trigger>
            <n-button @click="reSort" :loading="loading">
              <template #icon>
                <n-icon>
                  <Refresh/>
                </n-icon>
              </template>
              随机排列座位
            </n-button>
          </template>
          真·随机排列座位
          <del>，六亲不认的那种</del>
        </n-tooltip>

      </div>
      <div> <!-- 下方工具条 -->
        <n-tooltip trigger="hover">
          <!--suppress VueUnrecognizedSlot -->
          <template #trigger>
            <n-switch v-model:value="coloringEdgeSeats" @update:value="repaint" :disabled="loading"/>
          </template>
          边缘位置高亮
        </n-tooltip>
        <n-button-group>
          <n-button @click="showSetting=true">设置</n-button>
          <n-button @click="showManager">人员管理</n-button>
          <n-button @click="showMultiAddModal">增加人员</n-button>
          <n-button @click="save" :disabled="loading">保存</n-button>
        </n-button-group>
      </div>
    </div>


    <n-modal v-model:show="showSetting" style="width: 60%">
      <n-card
          style="width: 60%"
          title="设置"
          :bordered="true"
          size="small"
          closable
          @close="showSetting=false"
      >
        <div class="flex flex-row justify-items-start" style="height: 60vh">
          <div class="px-2 pt-2 mr-2 bg-gray-200 rounded">
            <n-list class="flex flex-col justify-center w-1/4 min-w-0">
              <n-list-item v-for="item in settings" :key="item.name" class="bg-gray-200 mt-auto">
                <n-button text @click="handleSetting(item)">{{ item.name }}</n-button>
              </n-list-item>
            </n-list>
          </div>
          <div class="flex flex-col justify-items-start w-full" :key="scKey">
            <div id="settingTitle"><p>{{ currentSetting.name }}</p></div>
            <div class="h-full overflow-y-hidden" id="settingContainer">
              <component :is="currentSetting.component" v-model:showAddModal="showAddModal"/>
            </div>
          </div>
        </div>
      </n-card>
    </n-modal>
    <div class="fixed bottom-0 left-0 mb-2 ml-2 text-xs">
      <p>TinyTools v{{ version }} Build {{ shout_sha }}</p>
    </div>
    <div class="fixed bottom-0 right-0 mb-2 mr-2 ">
      <audio controls id="player" src="https://music.163.com/song/media/outer/url?id=430620198.mp3"></audio>
    </div>
  </div>
</template>

<script setup>
import { nextTick, onMounted, onUnmounted, ref, watch, toRaw } from 'vue'
import {
  NButton,
  NButtonGroup,
  NCard,
  NIcon,
  NModal,
  NSwitch,
  NTooltip,
  NLayout,
  NLayoutContent,
  useMessage
} from 'naive-ui'
import { Refresh, RefreshDot } from '@vicons/tabler'
import SeatTable from '@/components/SeatTable.vue'
import BgmSetting from '@/components/BgmSetting.vue'
import PersonManage from '@/components/PersonManage.vue'
import About from '../components/About.vue'
import { useSeatStore } from '@/stores/seat'
import { usePersonStore } from '@/stores/person'
import { useSettingStore } from '@/stores/setting'
import { storeToRefs } from 'pinia'
import { replaceArrayElements } from '@/assets/script/seatHelper'
import { shuffle } from 'lodash-es'
import { getDefaultMusic } from '../assets/script/musicHelper'

const version = __APP_VERSION__
const github_sha = __GITHUB_SHA__ || 'Developing'
const shout_sha =github_sha.substring(0,7)

const message = useMessage()
//const worker = new Worker('src/assets/script/seatWorker.js', { type: 'module' })
const worker = new Worker(new URL('../assets/script/seatWorker.js', import.meta.url), {
  type: 'module',
})

const seatStore = useSeatStore()
const personStore = usePersonStore()
const settingStore = useSettingStore()

const { allSeats, oldRenderingList } = storeToRefs(seatStore)
const { allPerson } = storeToRefs(personStore)
const { coloringEdgeSeats, bgms } = storeToRefs(settingStore)

const showSetting = ref(false)
const showAddModal = ref(false)
const currentDate = ref('')
const currentTime = ref('')
const loading = ref(false)
const times = ref(5)
const stKey = ref(Math.random())
const scKey = ref(Math.random())

const settings = [
  { name: '🎶背景音乐', component: BgmSetting },
  { name: '💁人员管理', component: PersonManage },
  { name: 'ℹ️关于', component: About }
]

let currentSetting = settings[0]

if (bgms.value.length === 0)
{
  bgms.value = getDefaultMusic()
}

let bgmList = shuffle(toRaw(bgms.value))
let bgmIndex = 0

const showManager = () => {
  currentSetting = { name: '💁人员管理', component: PersonManage }
  showSetting.value = true
}
const showMultiAddModal = () => {
  currentSetting = { name: '💁人员管理', component: PersonManage }
  showSetting.value = true
  showAddModal.value = true
}
const handleSetting = (x) => {
  currentSetting = x
  scKey.value = Math.random()
}

const playBgm = () => {
  const player = document.getElementById('player')
  const bgm = bgmList[bgmIndex]
  console.log(bgmList)
  if (bgmIndex < bgmList.length - 1) bgmIndex++
  else bgmIndex = 0
  player.src = bgm.url
  player.currentTime = bgm.offset
  message.info('正在播放：' + bgm.name)
  console.log('正在播放：' + bgm.name)
  player.play()
}

// 在组件挂载时开始更新日期和时间
onMounted(() => {
  updateDateTime()
  setInterval(updateDateTime, 1000)
  const player = document.getElementById('player')
  player.volume = 0.6 //关 音 菩 萨
})

// 在组件卸载时停止更新日期和时间
onUnmounted(() => {
  clearInterval(updateDateTime)
})

// 更新日期和时间
function updateDateTime()
{
  const now = new Date()
  const date = now.toLocaleDateString()
  const time = now.toLocaleTimeString()
  currentDate.value = date
  currentTime.value = time
}

const save = async () => {
  async function loadModule()
  {
    return await import('html2canvas')
  }

  const div = document.getElementById('target-div')
  const canvas = document.createElement('canvas')
  const w = div.offsetWidth
  const h = div.offsetHeight
  canvas.width = w * 2
  canvas.height = h * 2
  canvas.style.width = w + 'px'
  canvas.style.height = h + 'px'
  const context = canvas.getContext('2d')
  context.scale(2, 2)
  const html2canvas = await loadModule()

  html2canvas.default(div, { canvas: canvas })
             .then(canvas => {
               // 将 Canvas 转换为图像数据 URL
               const imageDataUrl = canvas.toDataURL()
               //console.log(imageDataUrl)
               // 创建一个 <a> 元素
               const link = document.createElement('a')
               link.href = imageDataUrl

               // 设置下载属性
               link.download = 'seat-' + currentDate.value + '-' + currentTime.value + '.png'

               // 模拟点击下载链接
               link.click()
             })
             .catch(error => {
               // 处理截图错误
               console.error(error)
             })
}

if ((allPerson.value.length !== 0 && allSeats.value.length === 0) || allPerson.value.length !== allSeats.value.length)
{
  allSeats.value = allPerson.value.map((name, index) => {
    return { name: name, index: index }
  })
  console.log('seat has been initialized')
}

const reSort = async () => {
  loading.value = true
  await nextTick()
  allSeats.value = shuffle(allSeats.value).map((item, index) => {return { ...item, index: index }})
  await nextTick()
  setTimeout(() => {loading.value = false}, 50)
}

const gacha = async () => {
  loading.value = true
  playBgm()
  const data = JSON.parse(JSON.stringify(allSeats.value))
  console.log('主线程向worker发送消息：', data)
  worker.postMessage(data)
  setTimeout(() => {loading.value = false}, allSeats.value.length * 550)
}

const rollSeats = async (x) => {
  loading.value = true
  await nextTick()
  const originSeats = [...allSeats.value]
  let count = 0 // 计数器

  playBgm()

  const intervalId = setInterval(async () => {
    // 执行某个操作
    allSeats.value = shuffle(allSeats.value).map((item, index) => {
      return {
        ...item,
        index: index
      }
    })
    await nextTick()
    count++ // 增加计数器

    if (count === (x + 1))
    {
      clearInterval(intervalId) // 达到执行次数后清除定时器
      setTimeout(() => {loading.value = false}, 500)
      allSeats.value = replaceArrayElements(originSeats).map((item, index) => {
        return {
          ...item,
          index: index
        }
      })
      const player = document.getElementById('player')
      player.pause()
    }
  }, 500)
}

const replaceSeats = async () => {
  loading.value = true
  console.log('开始重新排列座位')
  const stopwatch = performance.now()
  await nextTick()
  allSeats.value = replaceArrayElements(allSeats.value).map((item, index) => {return { ...item, index: index }})
  await nextTick()
  console.log('执行完成,用时' + (performance.now() - stopwatch) + 'ms')
  setTimeout(() => {loading.value = false}, 50)
}

const reloadSeatTable = async () => {
  allSeats.value = [...allSeats.value] //这里不是脱裤子放屁，是为了触发侦听器
  stKey.value = Math.random() //刷新一下SeatTable组件
  console.log('SeatTable has been reload')
}

const repaint = async (x) => {
  if (!x) allSeats.value.forEach(item => item.color = null)
  await reloadSeatTable()
}

watch(allPerson, reloadSeatTable)
watch(allSeats, () => {
  console.log('seat changed')
})
watch(oldRenderingList, () => {
  stKey.value = Math.random()
})

worker.onmessage = function (event) {
  // console.log('接收到Web Worker的消息:', event.data)
  console.log('收到Web Worker的更新')
  //oldRenderingList.value=getRenderingList(event.data,oldRenderingList.value)
  allSeats.value = event.data
  reloadSeatTable()
}

</script>

<style scoped>

</style>
